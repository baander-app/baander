<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>partitioned_convolver.wasm demo</title>
    <style>
        body { font-family: system-ui, sans-serif; background:#111; color:#eee; margin:20px; }
        button { padding:8px 12px; }
        pre { background:#000; padding:12px; border-radius:6px; }
    </style>
</head>
<body>
<button id="run">Convolve impulse</button>
<pre id="out">Waitingâ€¦</pre>
<script type="module">
  import { loadConvolver } from './partitioned_convolver.js';
  const api = await loadConvolver();
  const out = document.getElementById('out');

  document.getElementById('run').onclick = () => {
    const ch = 1, block = 256;

    // A tiny exponential decay IR (mono)
    const irLen = 512;
    const ir = new Float32Array(irLen);
    for (let i=0;i<irLen;i++) ir[i] = Math.pow(0.995, i);

    // Input: impulse at frame 0 followed by zeros
    const frames = 1024;
    const input = new Float32Array(frames*ch);
    input[0] = 1.0;

    const heapF32 = new Float32Array(api.memory.buffer);
    const base = 1<<20;
    const irPtr = base;
    const inPtr = irPtr + ir.byteLength;
    const outPtr = inPtr + input.byteLength;

    heapF32.set(ir,  irPtr>>2);
    heapF32.set(input, inPtr>>2);

    const ctx = api.create(irPtr, irLen, block, ch);
    api.process(ctx, inPtr, outPtr, frames);

    const outSlice = heapF32.subarray(outPtr>>2, (outPtr>>2)+frames*ch);
    out.textContent = `First 12 samples: ${Array.from(outSlice.slice(0,12)).map(v=>v.toFixed(4)).join(', ')}`;

    api.destroy(ctx);
  };
</script>
</body>
</html>
